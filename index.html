<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <style>
      
    </style>
  </head>
  <body>
    <h1>Faire actions</h1>
    <button id="perso">Action perso</button>
    <button id="collective">Action collective</button>
    <form id="login">
      <!--<input type="text" name="username">
      <input type="text" name="password">-->
      <input type="submit" value="login">
    </form>
    
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      var socket;
      
      var tockenStatic = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJmaXJzdF9uYW1lIjoiSm9obiIsImxhc3RfbmFtZSI6IkRvZSIsImVtYWlsIjoiam9obkBkb2UuY29tIiwiaWQiOjEyMywiaWF0IjoxNDI5NjkwMDM2LCJleHAiOjE0Mjk3MDgwMzZ9.ktBoP0JHjqCFXgHysg9upOvhmNmtiB-Z4n2-SJFym1w"
      /*var id;
      
      socket.on('connect', function() {
        id = socket.io.engine.id;
        console.log(id)
      }); 
      
      $('form').submit(function(){
        socket.emit('chat message', $('#m').val());
        $('#m').val('');
        return false;
      });
      socket.on('chat message', function(msg){
        $('#messages').append($('<li>').text(msg));
      });
      
      
      */
      
      
      function connect_socket (token) {
        socket = io.connect('', {
          query: 'token=' + token
        });

        socket.on('connect', function () {
          console.log('authenticated');
        }).on('disconnect', function () {
          console.log('disconnected');
        }).on("error", function(error) {
          if (error.type == "UnauthorizedError" || error.code == "invalid_token") {
            // redirect user to login page perhaps?
            console.log('invalide tocken')
          }
        });
        
        
        $('#perso').click(function(e){
          socket.emit('action perso', 'toto')
        })
      }
      
      var suc = function (result) {
        console.log('login succesfull')
        connect_socket(result.token);
      }

      $('#login').submit(function (e) {
        e.preventDefault();
        var data = {
          username: $('username').val(),
          password: $('password').val()
        }
        
        $.ajax({
          type: "POST",
          url: '/login',
          data: '{"username":"joel", "password":"admin1234"}',
          success: suc,
          dataType: 'json',
          contentType:"application/json; charset=utf-8"
        });
        
        
        /*$.post('/login', '{"toto":15}', 'json').done(function (result) {
          alert('login succesfull')
          connect_socket(result.token);
        });
        */
      });
    </script>
  </body>
</html>
